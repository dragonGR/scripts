#!/bin/bash

# Define color variables for bright green, bright red, and reset
BOLD_BRIGHT_GREEN="\e[1;92m"
BOLD_BRIGHT_RED="\e[1;91m"
RESET="\e[0m"

# Clear the terminal and enable immediate script exit on errors
clear
set -e

# Function to print messages in bright green
function print_green {
    echo -e "${BOLD_BRIGHT_GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${RESET}"
}

# Function to print kernel version in bright red bold
function print_red_bold {
    echo -e "${BOLD_BRIGHT_RED}$1${RESET}"
}

# Variables
KERNEL_DIR="$HOME/kernel_build"
KERNEL_BASE_URL="https://cdn.kernel.org/pub/linux/kernel"
CURRENT_KERNEL_VERSION=$(uname -r | cut -d '-' -f1)  # Extract major.minor version
MAJOR_VERSION=$(echo "$CURRENT_KERNEL_VERSION" | cut -d '.' -f1)  # Major version (e.g., 6)
LATEST_KERNEL_VERSION=""
LATEST_KERNEL_TARBALL=""

# Function to get the latest kernel version from kernel.org
get_latest_kernel_version() {
    print_green "Fetching the latest kernel version from cdn.kernel.org..."

    local version_list
    version_list=$(wget -qO- "$KERNEL_BASE_URL/v${MAJOR_VERSION}.x/" | \
        grep -oP 'linux-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n 1)

    if [ -z "$version_list" ]; then
        print_green "Failed to fetch the latest kernel version. Exiting."
        exit 1
    fi

    LATEST_KERNEL_VERSION=$version_list
    LATEST_KERNEL_TARBALL="linux-${LATEST_KERNEL_VERSION}.tar.xz"

    print_green "Latest kernel version found: $(print_red_bold "$LATEST_KERNEL_VERSION")"
}

# Function to check if the latest kernel version is already installed
check_existing_kernel() {
    local current_kernel
    current_kernel=$(uname -r | cut -d '-' -f1)
    if [ "$current_kernel" == "$LATEST_KERNEL_VERSION" ]; then
        print_green "The most recent kernel version is installed: $(print_red_bold "$LATEST_KERNEL_VERSION")"
        exit 0
    fi
}

# Function to download and extract the kernel source
download_kernel() {
    print_green "Downloading Linux Kernel $LATEST_KERNEL_VERSION..."
    mkdir -p "$KERNEL_DIR"
    cd "$KERNEL_DIR"

    local kernel_url="$KERNEL_BASE_URL/v${MAJOR_VERSION}.x/${LATEST_KERNEL_TARBALL}"

    if ! wget "$kernel_url"; then
        print_green "Failed to download kernel source from $kernel_url. Exiting."
        exit 1
    fi

    if ! tar -xf "$LATEST_KERNEL_TARBALL"; then
        print_green "Failed to extract kernel source. Exiting."
        exit 1
    fi

    cd linux-"$LATEST_KERNEL_VERSION"
}

# Function to extract and update the current kernel configuration
extract_and_update_config() {
    print_green "Extracting current kernel configuration..."

    # Extract the current config from the running kernel
    if ! zcat /proc/config.gz > .config; then
        print_green "Failed to extract kernel configuration. Exiting."
        exit 1
    fi
    print_green "Kernel configuration extracted successfully!"
}

# Function to extract the current kernel configuration
extract_config() {
    print_green "Extracting current kernel configuration..."
    if ! zcat /proc/config.gz > .config; then
        print_green "Failed to extract kernel configuration. Exiting."
        exit 1
    fi
    print_green "Kernel configuration extracted successfully!"
}

# Function to compile the kernel
compile_kernel() {
    print_green "Compiling the kernel..."
    if ! make -j"$(nproc)"; then
        print_green "Kernel compilation failed. Exiting."
        exit 1
    fi
    print_green "Kernel compiled successfully!"
}

# Function to install the kernel and update the bootloader
install_kernel() {
    print_green "Installing the kernel..."

    if ! sudo make modules_install; then
        print_green "Failed to install kernel modules. Exiting."
        exit 1
    fi

    if ! sudo make install; then
        print_green "Kernel installation failed. Exiting."
        exit 1
    fi

    print_green "Kernel installed successfully! Updating GRUB bootloader..."

    # Update GRUB or bootloader
    if command -v update-grub >/dev/null; then
        sudo update-grub
    elif command -v grub2-mkconfig >/dev/null; then
        sudo grub2-mkconfig -o /boot/grub2/grub.cfg
    else
        print_green "GRUB bootloader not found. You may need to update the bootloader manually."
    fi

    print_green "Kernel installed successfully! Reboot your system to use the new kernel."
}

# Function to clean up temporary files
cleanup() {
    print_green "Cleaning up..."
    rm -f "$KERNEL_DIR/$LATEST_KERNEL_TARBALL"
    print_green "Cleanup completed!"
}

# Handle script interruptions
trap 'print_green "Aborting..."; cleanup; exit 1;' INT TERM

# Automating the process
get_latest_kernel_version
check_existing_kernel
download_kernel
extract_and_update_config
compile_kernel
install_kernel
cleanup

# Final message
clear
print_green "Kernel build and installation completed!"
